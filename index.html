<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¢×¨×›×ª × ×™×”×•×œ ×–×× ×™×</title>
  <!-- Google Fonts for futuristic style -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #4CAF50;
      --background-color: #f0f8ff;
      --error-color: #d32f2f;
      --success-color: #388e3c;
      /* Updated dark mode variables */
      --dark-bg: #121212;
      --dark-text: #e0e0e0;
    }

    /* Keyframe animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes gradientBackground {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* Futuristic animated background for futuristic theme */
    body.futuristic-theme {
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientBackground 15s ease infinite;
    }

    /* Basic reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Arial', sans-serif;
      /* Direction updated via JS if needed */
      direction: rtl;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--primary-color);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s, font-family 0.3s;
    }
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    /* Responsive design */
    @media (max-width: 600px) {
      input, select { width: 90%; }
      .auth-container, .day-container { margin: 1rem auto; }
    }
    .auth-container {
      max-width: 400px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255,255,255,0.9);
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease-out;
    }
    .dashboard {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
    }
    #clock { font-size: 1.2em; font-weight: bold; }
    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: var(--secondary-color);
      color: white;
      transition: all 0.3s ease;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    button:focus { outline: 2px solid var(--secondary-color); }
    input, select {
      margin: 10px;
      padding: 12px;
      width: 300px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      border-color: var(--secondary-color);
      outline: none;
    }
    .day-container {
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .day-container:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .subject-card {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      background: #e8f5e9;
      padding: 8px 15px;
      margin: 5px;
      border-radius: 20px;
      cursor: grab;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .subject-card:hover {
      background: #c8e6c9;
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(0,200,150,0.5);
    }
    .subject-card.completed {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .remove-btn {
      cursor: pointer;
      margin-left: 10px;
      font-weight: bold;
      color: var(--error-color);
    }
    .calendar-view {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .calendar-view div {
      padding: 10px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .calendar-view div:hover { background: #f0f0f0; }
    /* Modal styles with ARIA roles for accessibility */
    .modal, .settings-modal, .profile-modal, .help-modal {
      display: none;
      position: fixed;
      background: rgba(255,255,255,0.95);
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1100;
      max-width: 300px;
      animation: fadeIn 0.3s ease-out;
    }
    .modal[role="dialog"], .profile-modal[role="dialog"], .help-modal[role="dialog"] {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .settings-modal[role="dialog"] {
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1001;
      animation: fadeIn 0.3s ease-out;
    }
    .error { background: #ffebee; color: var(--error-color); }
    .success { background: #e8f5e9; color: var(--success-color); }

    /* Dark mode adjustments */
    .dark-mode .day-container {
      background: #1e1e1e;
      color: var(--dark-text);
    }
    .dark-mode .subject-card {
      background: #2c2c2c;
      color: var(--dark-text);
    }
    .dark-mode .modal,
    .dark-mode .settings-modal,
    .dark-mode .profile-modal,
    .dark-mode .help-modal {
      background: #1e1e1e;
      color: var(--dark-text);
    }

    /* Weather and bag items sections */
    .weather-section {
      margin: 20px 0;
      padding: 20px;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: background 0.3s;
    }
    .bag-items {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }
    /* Progress bar */
    #progress-container {
      width: 100%;
      background: #ddd;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }
    #progress-bar {
      height: 20px;
      background: var(--secondary-color);
      width: 0%;
      transition: width 0.5s;
    }
  </style>
</head>
<body>
  <!-- Authentication Container -->
  <div class="auth-container" id="auth-container">
    <h1 id="auth-heading">ğŸ“ ××¢×¨×›×ª × ×™×”×•×œ ×œ×™××•×“×™× ××ª×§×“××ª</h1>
    <div id="login-or-register">
      <button id="btn-new-registration" title="Register" onclick="showAuthForm('register')">ğŸ“ ×”×¨×©××” ×—×“×©×”</button>
      <button id="btn-login" title="Login" onclick="showAuthForm('login')">ğŸ”‘ ×”×ª×—×‘×¨×•×ª</button>
    </div>
    <div id="register-form" style="display: none;">
      <h2 id="register-heading">×”×¨×©××”</h2>
      <input type="text" id="reg-username" placeholder="×©× ××©×ª××©" aria-label="Username">
      <input type="password" id="reg-password" placeholder="×¡×™×¡××”" aria-label="Password">
      <input type="password" id="reg-confirm-password" placeholder="××™××•×ª ×¡×™×¡××”" aria-label="Confirm Password">
      <button onclick="register()">×”×¨×©××”</button>
    </div>
    <div id="login-form" style="display: none;">
      <h2 id="login-heading">×”×ª×—×‘×¨×•×ª</h2>
      <input type="text" id="login-username" placeholder="×©× ××©×ª××©" aria-label="Username">
      <input type="password" id="login-password" placeholder="×¡×™×¡××”" aria-label="Password">
      <button onclick="login()">×”×ª×—×‘×¨</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <header>
      <div>
        <h1 id="dashboard-greeting">×©×œ×•×, <span id="current-user"></span>!</h1>
        <div id="clock"></div>
      </div>
      <div>
        <button id="btn-logout" title="Logout" onclick="logout()">ğŸšª ×™×¦×™××”</button>
        <button id="btn-dark-mode" title="Toggle Dark Mode" onclick="toggleDarkMode()">ğŸŒ™ ××¦×‘ ×œ×™×œ×”</button>
        <select id="language-select" onchange="changeLanguage(this.value)" title="Select Language">
          <option value="he">×¢×‘×¨×™×ª</option>
          <option value="en">English</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="es">EspaÃ±ol</option>
        </select>
        <button id="btn-settings" title="Settings" onclick="toggleSettings()">âš™ï¸ ×”×’×“×¨×•×ª</button>
        <button id="btn-profile" title="Edit Profile" onclick="toggleProfile()">ğŸ‘¤ ×¤×¨×•×¤×™×œ</button>
        <button id="btn-help" title="Help" onclick="toggleHelp()">â“ ×¢×–×¨×”</button>
      </div>
    </header>

    <!-- Weather Section -->
    <section class="weather-section">
      <h2 id="weather-heading">â›… ××–×’ ××•×•×™×¨ ×•×”××œ×¦×•×ª ×œ×‘×•×©</h2>
      <select id="city-select" onchange="getWeather(this.value)" title="Select City">
        <option value="">×‘×—×¨ ×¢×™×¨</option>
        <option value="Tel Aviv">×ª×œ ××‘×™×‘</option>
        <option value="Jerusalem">×™×¨×•×©×œ×™×</option>
        <option value="Haifa">×—×™×¤×”</option>
        <option value="Beer Sheva">×‘××¨ ×©×‘×¢</option>
        <option value="Eilat">××™×œ×ª</option>
      </select>
      <div id="weather-info"></div>
      <div class="bag-items" id="clothing-recommendations"></div>
    </section>

    <!-- Daily Bag Items Section -->
    <section class="weather-section">
      <h2 id="bag-items-heading">ğŸ’ ×¤×¨×™×˜×™× ×™×•××™×™× ×œ×ª×™×§</h2>
      <div id="daily-bag-items"></div>
    </section>

    <!-- Calendar View -->
    <section class="calendar-view" id="calendar"></section>

    <!-- Schedule Management Section -->
    <section id="schedule-management">
      <h2 id="schedule-heading">ğŸ“… × ×™×”×•×œ ×–×× ×™×</h2>
      <input type="text" id="search-input" placeholder="×—×¤×© × ×•×©×..." aria-label="Search Subject">
      <select id="category-filter" onchange="filterByCategory(this.value)" title="Filter by Category">
        <option value="all">×”×›×œ</option>
        <option value="××ª××˜×™×§×”">××ª××˜×™×§×”</option>
        <option value="××“×¢×™×">××“×¢×™×</option>
        <option value="×”×™×¡×˜×•×¨×™×”">×”×™×¡×˜×•×¨×™×”</option>
        <option value="×›×œ×œ×™">×›×œ×œ×™</option>
      </select>
      <!-- Progress Bar -->
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      <div id="days-container"></div>
    </section>

    <!-- Export and Backup Options -->
    <section class="export-options">
      <button id="btn-export-schedule" title="Export Schedule" onclick="exportSchedule()">ğŸ“¤ ×™×™×¦×•× ××¢×¨×›×ª ×©×¢×•×ª</button>
      <button id="btn-export-pdf" title="Export to PDF" onclick="exportToPDF()">ğŸ“„ ×™×™×¦×•× ×œ-PDF</button>
      <button id="btn-export-csv" title="Export as CSV" onclick="exportScheduleCSV()">ğŸ“‘ ×™×™×¦×•× ×›-CSV</button>
      <button id="btn-import-schedule" title="Import Schedule" onclick="importSchedule()">ğŸ“¥ ×™×‘×•× ××¢×¨×›×ª ×©×¢×•×ª</button>
      <button id="btn-backup-cloud" title="Backup to Cloud" onclick="backupToCloud()">â˜ï¸ ×’×™×‘×•×™ ×œ×¢× ×Ÿ</button>
      <button id="btn-restore-cloud" title="Restore from Cloud" onclick="restoreFromCloud()">â™»ï¸ ×©×—×–×•×¨ ××’×™×‘×•×™</button>
      <button id="btn-theme-dark" title="Dark Theme" onclick="setTheme('dark')">× ×•×©× ×›×”×”</button>
      <button id="btn-theme-light" title="Light Theme" onclick="setTheme('light')">× ×•×©× ×‘×”×™×¨</button>
      <select id="theme-select" onchange="setCustomTheme(this.value)" title="Custom Theme">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
        <option value="blue">Blue</option>
        <option value="green">Green</option>
        <option value="red">Red</option>
        <option value="futuristic">Futuristic</option>
      </select>
      <button id="btn-print-schedule" title="Print Schedule" onclick="printSchedule()">ğŸ–¨ï¸ ×”×“×¤×¡ ××¢×¨×›×ª ×©×¢×•×ª</button>
      <button id="btn-speech" title="Voice Input" onclick="startSpeechRecognition()">ğŸ¤ ×”×•×¡×¤×ª ×§×•×œ×™</button>
      <!-- NEW: Bag Management Button -->
      <button id="btn-bag-management" title="Bag Management" onclick="openBagModal()">ğŸ‘œ × ×™×”×•×œ ×ª×™×§</button>
    </section>
  </div>

  <!-- Modal for Editing Subject (role="dialog") -->
  <div class="modal" id="subject-modal" role="dialog" aria-modal="true" aria-labelledby="edit-subject-heading">
    <h3 id="edit-subject-heading">×¢×¨×™×›×ª × ×•×©×</h3>
    <input type="text" id="edit-subject-input">
    <input type="text" id="edit-time-input" placeholder="×©×¢×” (×œ×“×•×’××”: 8:00-9:00)">
    <select id="edit-category-input">
      <option value="×›×œ×œ×™">×›×œ×œ×™</option>
      <option value="××ª××˜×™×§×”">××ª××˜×™×§×”</option>
      <option value="××“×¢×™×">××“×¢×™×</option>
      <option value="×”×™×¡×˜×•×¨×™×”">×”×™×¡×˜×•×¨×™×”</option>
    </select>
    <button onclick="saveEditedSubject()">×©××•×¨ ×©×™× ×•×™×™×</button>
  </div>

  <!-- Settings Modal (role="dialog") -->
  <div class="settings-modal" id="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settings-heading">
    <h3 id="settings-heading">×”×’×“×¨×•×ª ××ª×§×“××•×ª</h3>
    <label for="font-select">×‘×—×¨ ×’×•×¤×Ÿ:</label>
    <select id="font-select" onchange="changeFont(this.value)">
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Orbitron">Orbitron</option>
      <option value="Roboto">Roboto</option>
    </select>
    <button onclick="resetSettings()">××¤×¡ ×”×’×“×¨×•×ª</button>
    <button onclick="alert('Feature coming soon: Notification Preferences')">×”×¢×“×¤×•×ª ×”×ª×¨××•×ª</button>
    <button onclick="alert('Feature coming soon: Auto-Sync Options')">××¤×©×¨×•×™×•×ª ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™</button>
    <button onclick="toggleSettings()">×¡×’×•×¨</button>
  </div>

  <!-- Profile Modal (role="dialog") -->
  <div class="profile-modal" id="profile-modal" role="dialog" aria-modal="true" aria-labelledby="profile-heading">
    <h3 id="profile-heading">×¤×¨×•×¤×™×œ ××©×ª××©</h3>
    <label for="profile-username">×©× ××©×ª××©:</label>
    <input type="text" id="profile-username" disabled>
    <label for="profile-password">×¡×™×¡××” ×—×“×©×”:</label>
    <input type="password" id="profile-password">
    <button onclick="updateProfile()">×¢×“×›×Ÿ ×¤×¨×•×¤×™×œ</button>
    <button onclick="toggleProfile()">×¡×’×•×¨</button>
  </div>

  <!-- Help Modal (role="dialog") -->
  <div class="help-modal" id="help-modal" role="dialog" aria-modal="true" aria-labelledby="help-heading">
    <h3 id="help-heading">×¢×–×¨×”</h3>
    <p>×‘×¨×•×›×™× ×”×‘××™× ×œ××¢×¨×›×ª × ×™×”×•×œ ×”×œ×™××•×“×™×. ×›××Ÿ ×ª×•×›×œ×•:</p>
    <ul>
      <li>×œ×”×•×¡×™×£, ×œ×¢×¨×•×š ×•×œ×¡××Ÿ × ×•×©××™× ×›×”×•×©×œ××•.</li>
      <li>×œ×¢×§×•×‘ ××—×¨×™ ×”×ª×§×“××•×ª×›× ×‘×××¦×¢×•×ª ×¡×¨×’×œ ×”×ª×§×“××•×ª ×•×× ×™××¦×™×•×ª ××ª×§×“××•×ª.</li>
      <li>×œ×”×©×ª××© ×‘×§×œ×˜ ×§×•×œ×™ ×œ×”×•×¡×¤×ª × ×•×©××™×.</li>
      <li>×œ×™×™×¦× ××ª ××¢×¨×›×ª ×”×©×¢×•×ª ×›-JSON, CSV ××• PDF.</li>
      <li>×œ×”×ª××™× ××™×©×™×ª ××ª ×”× ×•×©×, ×”×’×•×¤×Ÿ, ×”×¦×‘×¢×™× ×•×”× ×¨××•×ª ×‘×¦×•×¨×” ×¢×ª×™×“× ×™×ª.</li>
    </ul>
    <button onclick="toggleHelp()">×¡×’×•×¨</button>
  </div>

  <!-- NEW: Bag Management Modal (role="dialog") -->
  <div class="modal" id="bag-modal" role="dialog" aria-modal="true" aria-labelledby="bag-modal-heading">
    <h3 id="bag-modal-heading">× ×™×”×•×œ ×ª×™×§ - ×—×•××¨×™× ×œ×”×•×¡×¤×”/×”×¡×¨×”</h3>
    <label for="bag-day-select">×‘×—×¨ ×™×•×:</label>
    <select id="bag-day-select">
      <option value="0">×¨××©×•×Ÿ</option>
      <option value="1">×©× ×™</option>
      <option value="2">×©×œ×™×©×™</option>
      <option value="3">×¨×‘×™×¢×™</option>
      <option value="4">×—××™×©×™</option>
      <option value="5">×©×™×©×™</option>
    </select>
    <button onclick="checkBagContents()">×‘×“×•×§ ×ª×™×§</button>
    <div id="bag-results"></div>
    <button onclick="closeBagModal()">×¡×’×•×¨</button>
  </div>

  <!-- Shared Overlay -->
  <div class="overlay" id="modal-overlay"></div>

  <script>
    "use strict";
    /***************** Global Variables & Dictionaries *****************/
    const daysOfWeek = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™'];
    let currentUser = null;
    let currentLang = localStorage.getItem('currentLang') || 'he';

    const translations = {
      en: {
        authHeading: "ğŸ“ ××¢×¨×›×ª × ×™×”×•×œ ×–×× ×™× ××ª×§×“××ª",
        newRegistration: "ğŸ“ New Registration",
        login: "ğŸ”‘ Login",
        registerHeading: "Register",
        loginHeading: "Login",
        usernamePlaceholder: "Username",
        passwordPlaceholder: "Password",
        confirmPasswordPlaceholder: "Confirm Password",
        logout: "ğŸšª Logout",
        darkMode: "ğŸŒ™ Dark Mode",
        weatherHeading: "â›… Weather and Clothing Recommendations",
        bagItemsHeading: "ğŸ’ Daily Bag Items",
        scheduleHeading: "ğŸ“… Schedule Management",
        addSubject: "Add Subject",
        sortSubjects: "Sort Subjects",
        clearDay: "Clear Day",
        edit: "Edit",
        addNote: "Add Note",
        reminder: "Reminder",
        exportSchedule: "ğŸ“¤ Export Schedule",
        exportToPDF: "ğŸ“„ Export to PDF",
        importSchedule: "ğŸ“¥ Import Schedule",
        backupToCloud: "â˜ï¸ Backup to Cloud",
        restoreFromCloud: "â™»ï¸ Restore from Cloud",
        lightMode: "Light Mode",
        themeDark: "Dark Theme",
        language: "Language",
        searchPlaceholder: "Search subject..."
      },
      he: {
        authHeading: "××¢×¨×›×ª × ×™×”×•×œ ×–×× ×™× ××ª×§×“××ª",
        newRegistration: "ğŸ“ ×”×¨×©××” ×—×“×©×”",
        login: "ğŸ”‘ ×”×ª×—×‘×¨×•×ª",
        registerHeading: "×”×¨×©××”",
        loginHeading: "×”×ª×—×‘×¨×•×ª",
        usernamePlaceholder: "×©× ××©×ª××©",
        passwordPlaceholder: "×¡×™×¡××”",
        confirmPasswordPlaceholder: "××™××•×ª ×¡×™×¡××”",
        logout: "ğŸšª ×™×¦×™××”",
        darkMode: "ğŸŒ™ ××¦×‘ ×œ×™×œ×”",
        weatherHeading: "â›… ××–×’ ××•×•×™×¨ ×•×”××œ×¦×•×ª ×œ×‘×•×©",
        bagItemsHeading: "ğŸ’ ×¤×¨×™×˜×™× ×™×•××™×™× ×œ×ª×™×§",
        scheduleHeading: "ğŸ“… × ×™×”×•×œ ××¢×¨×›×ª ×©×¢×•×ª",
        addSubject: "×”×•×¡×£ × ×•×©×",
        sortSubjects: "××™×™×Ÿ × ×•×©××™×",
        clearDay: "× ×§×” ×™×•×",
        edit: "×¢×¨×•×š",
        addNote: "×”×•×¡×£ ×”×¢×¨×”",
        reminder: "×ª×–×›×•×¨×ª",
        exportSchedule: "ğŸ“¤ ×™×™×¦×•× ××¢×¨×›×ª ×©×¢×•×ª",
        exportToPDF: "ğŸ“„ ×™×™×¦×•× ×œ-PDF",
        importSchedule: "ğŸ“¥ ×™×‘×•× ××¢×¨×›×ª ×©×¢×•×ª",
        backupToCloud: "â˜ï¸ ×’×™×‘×•×™ ×œ×¢× ×Ÿ",
        restoreFromCloud: "â™»ï¸ ×©×—×–×•×¨ ××’×™×‘×•×™",
        lightMode: "××¦×‘ ×‘×”×™×¨",
        themeDark: "× ×•×©× ×›×”×”",
        language: "×©×¤×”",
        searchPlaceholder: "×—×¤×© × ×•×©×..."
      },
      ru: {
        authHeading: "ğŸ“ ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼",
        newRegistration: "ğŸ“ ĞĞ¾Ğ²Ğ°Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ",
        login: "ğŸ”‘ Ğ’Ñ…Ğ¾Ğ´",
        registerHeading: "Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ",
        loginHeading: "Ğ’Ñ…Ğ¾Ğ´",
        usernamePlaceholder: "Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ",
        passwordPlaceholder: "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ",
        confirmPasswordPlaceholder: "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ",
        logout: "ğŸšª Ğ’Ñ‹Ñ…Ğ¾Ğ´",
        darkMode: "ğŸŒ™ Ğ¢ĞµĞ¼Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼",
        weatherHeading: "â›… ĞŸĞ¾Ğ³Ğ¾Ğ´Ğ° Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¾Ğ´ĞµĞ¶Ğ´Ğµ",
        bagItemsHeading: "ğŸ’ Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ğ²ĞµÑ‰Ğ¸ Ğ² ÑÑƒĞ¼ĞºĞµ",
        scheduleHeading: "ğŸ“… Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸ĞµĞ¼",
        addSubject: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚",
        sortSubjects: "Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñ‹",
        clearDay: "ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ½ÑŒ",
        edit: "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ",
        addNote: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºÑƒ",
        reminder: "ĞĞ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ",
        exportSchedule: "ğŸ“¤ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ",
        exportToPDF: "ğŸ“„ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² PDF",
        importSchedule: "ğŸ“¥ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ",
        backupToCloud: "â˜ï¸ Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ¾",
        restoreFromCloud: "â™»ï¸ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ°",
        lightMode: "Ğ¡Ğ²ĞµÑ‚Ğ»Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼",
        themeDark: "Ğ¢ĞµĞ¼Ğ½Ğ°Ñ Ñ‚ĞµĞ¼Ğ°",
        language: "Ğ¯Ğ·Ñ‹Ğº",
        searchPlaceholder: "ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ°..."
      },
      ar: {
        authHeading: "ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±Ø§Ø³Ø§Øª Ù…ØªÙ‚Ø¯Ù…",
        newRegistration: "ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯",
        login: "ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        registerHeading: "ØªØ³Ø¬ÙŠÙ„",
        loginHeading: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        usernamePlaceholder: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
        passwordPlaceholder: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        confirmPasswordPlaceholder: "ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        logout: "ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
        darkMode: "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ",
        weatherHeading: "â›… Ø§Ù„Ø·Ù‚Ø³ ÙˆØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ù„Ø§Ø¨Ø³",
        bagItemsHeading: "ğŸ’ Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
        scheduleHeading: "ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„",
        addSubject: "Ø£Ø¶Ù Ù…Ø§Ø¯Ø©",
        sortSubjects: "ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ø¯",
        clearDay: "Ù…Ø³Ø­ Ø§Ù„ÙŠÙˆÙ…",
        edit: "ØªØ¹Ø¯ÙŠÙ„",
        addNote: "Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø©",
        reminder: "ØªØ°ÙƒÙŠØ±",
        exportSchedule: "ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„",
        exportToPDF: "ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF",
        importSchedule: "ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„",
        backupToCloud: "â˜ï¸ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
        restoreFromCloud: "â™»ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
        lightMode: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­",
        themeDark: "Ø§Ù„Ø³Ù…Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©",
        language: "Ø§Ù„Ù„ØºØ©",
        searchPlaceholder: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§Ø¯Ø©..."
      },
      es: {
        authHeading: "ğŸ“ Sistema Avanzado de GestiÃ³n de Estudios",
        newRegistration: "ğŸ“ Nueva Registro",
        login: "ğŸ”‘ Iniciar sesiÃ³n",
        registerHeading: "Registrarse",
        loginHeading: "Iniciar sesiÃ³n",
        usernamePlaceholder: "Nombre de usuario",
        passwordPlaceholder: "ContraseÃ±a",
        confirmPasswordPlaceholder: "Confirmar contraseÃ±a",
        logout: "ğŸšª Cerrar sesiÃ³n",
        darkMode: "ğŸŒ™ Modo oscuro",
        weatherHeading: "â›… Clima y recomendaciones de vestimenta",
        bagItemsHeading: "ğŸ’ ArtÃ­culos diarios para la mochila",
        scheduleHeading: "ğŸ“… GestiÃ³n de horarios",
        addSubject: "Agregar materia",
        sortSubjects: "Ordenar materias",
        clearDay: "Limpiar dÃ­a",
        edit: "Editar",
        addNote: "Agregar nota",
        reminder: "Recordatorio",
        exportSchedule: "ğŸ“¤ Exportar horario",
        exportToPDF: "ğŸ“„ Exportar a PDF",
        importSchedule: "ğŸ“¥ Importar horario",
        backupToCloud: "â˜ï¸ Respaldo en la nube",
        restoreFromCloud: "â™»ï¸ Restaurar desde la nube",
        lightMode: "Modo claro",
        themeDark: "Tema oscuro",
        language: "Idioma",
        searchPlaceholder: "Buscar materia..."
      }
    };

    const themes = {
      light: {
        '--background-color': '#f0f8ff',
        '--primary-color': '#2c3e50',
        '--secondary-color': '#4CAF50'
      },
      dark: {
        '--background-color': '#121212',
        '--primary-color': '#e0e0e0',
        '--secondary-color': '#4CAF50'
      },
      blue: {
        '--background-color': '#e0f7fa',
        '--primary-color': '#01579b',
        '--secondary-color': '#0288d1'
      },
      green: {
        '--background-color': '#e8f5e9',
        '--primary-color': '#1b5e20',
        '--secondary-color': '#43a047'
      },
      red: {
        '--background-color': '#ffebee',
        '--primary-color': '#b71c1c',
        '--secondary-color': '#e53935'
      },
      futuristic: {
        '--background-color': 'transparent',
        '--primary-color': '#ffffff',
        '--secondary-color': '#23d5ab'
      }
    };

    /***************** Multi-Language Functions *****************/
    function updateLanguage() {
      localStorage.setItem('currentLang', currentLang);
      document.body.dir = (currentLang === 'he' || currentLang === 'ar') ? "rtl" : "ltr";
      document.getElementById('auth-heading').textContent = translations[currentLang].authHeading;
      document.getElementById('btn-new-registration').textContent = translations[currentLang].newRegistration;
      document.getElementById('btn-login').textContent = translations[currentLang].login;
      document.getElementById('register-heading').textContent = translations[currentLang].registerHeading;
      document.getElementById('login-heading').textContent = translations[currentLang].loginHeading;
      document.getElementById('reg-username').placeholder = translations[currentLang].usernamePlaceholder;
      document.getElementById('reg-password').placeholder = translations[currentLang].passwordPlaceholder;
      document.getElementById('reg-confirm-password').placeholder = translations[currentLang].confirmPasswordPlaceholder;
      document.getElementById('login-username').placeholder = translations[currentLang].usernamePlaceholder;
      document.getElementById('login-password').placeholder = translations[currentLang].passwordPlaceholder;
      document.getElementById('btn-logout').textContent = translations[currentLang].logout;
      document.getElementById('btn-dark-mode').textContent = translations[currentLang].darkMode;
      document.getElementById('weather-heading').textContent = translations[currentLang].weatherHeading;
      document.getElementById('bag-items-heading').textContent = translations[currentLang].bagItemsHeading;
      document.getElementById('schedule-heading').textContent = translations[currentLang].scheduleHeading;
      document.getElementById('search-input').placeholder = translations[currentLang].searchPlaceholder;
      document.getElementById('btn-export-schedule').textContent = translations[currentLang].exportSchedule;
      document.getElementById('btn-export-pdf').textContent = translations[currentLang].exportToPDF;
      document.getElementById('btn-import-schedule').textContent = translations[currentLang].importSchedule;
      document.getElementById('btn-backup-cloud').textContent = translations[currentLang].backupToCloud;
      document.getElementById('btn-restore-cloud').textContent = translations[currentLang].restoreFromCloud;
      document.getElementById('btn-theme-dark').textContent = translations[currentLang].themeDark;
      document.getElementById('btn-theme-light').textContent = translations[currentLang].lightMode;
      renderScheduleUI();
    }
    function changeLanguage(lang) {
      currentLang = lang;
      updateLanguage();
    }

    /***************** Theme Functions *****************/
    function setTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        document.body.classList.remove('futuristic-theme');
      } else if (theme === 'light') {
        document.body.classList.remove('dark-mode');
        document.body.classList.remove('futuristic-theme');
      }
      localStorage.setItem('currentTheme', theme);
    }
    function setCustomTheme(themeName) {
      if (themes[themeName]) {
        Object.keys(themes[themeName]).forEach(key => {
          document.documentElement.style.setProperty(key, themes[themeName][key]);
        });
        if (themeName === 'futuristic') {
          document.body.classList.add('futuristic-theme');
          document.body.classList.remove('dark-mode');
        } else {
          document.body.classList.remove('futuristic-theme');
        }
        localStorage.setItem('currentCustomTheme', themeName);
      }
    }

    /***************** Toggle Dark Mode *****************/
    function toggleDarkMode() {
      if(document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('currentTheme', 'light');
      } else {
        document.body.classList.add('dark-mode');
        localStorage.setItem('currentTheme', 'dark');
      }
    }

    /***************** Additional Settings Functions *****************/
    function toggleSettings() {
      const settingsModal = document.getElementById('settings-modal');
      settingsModal.style.display = (settingsModal.style.display === 'block') ? 'none' : 'block';
      document.getElementById('modal-overlay').style.display = (settingsModal.style.display === 'block') ? 'block' : 'none';
    }
    function resetSettings() {
      localStorage.removeItem('currentLang');
      localStorage.removeItem('currentTheme');
      localStorage.removeItem('currentCustomTheme');
      currentLang = 'he';
      setTheme('light');
      setCustomTheme('light');
      updateLanguage();
      toggleSettings();
      showMessage('×”×”×’×“×¨×•×ª ××•×¤×¡×•', 'success');
    }
    function changeFont(fontName) {
      document.body.style.fontFamily = fontName;
      localStorage.setItem('currentFont', fontName);
    }

    /***************** Profile Functions *****************/
    function toggleProfile() {
      const profileModal = document.getElementById('profile-modal');
      profileModal.style.display = (profileModal.style.display === 'block') ? 'none' : 'block';
      document.getElementById('modal-overlay').style.display = (profileModal.style.display === 'block') ? 'block' : 'none';
      if (currentUser) {
        document.getElementById('profile-username').value = currentUser;
      }
    }
    function updateProfile() {
      showMessage('×¤×¨×•×¤×™×œ ×¢×•×“×›×Ÿ', 'success');
      toggleProfile();
    }

    /***************** Help Functions *****************/
    function toggleHelp() {
      const helpModal = document.getElementById('help-modal');
      helpModal.style.display = (helpModal.style.display === 'block') ? 'none' : 'block';
      document.getElementById('modal-overlay').style.display = (helpModal.style.display === 'block') ? 'block' : 'none';
    }

    /***************** Additional Functions *****************/
    const users = JSON.parse(localStorage.getItem('schoolUsers') || '{}');
    async function getWeather(city) {
      if (!city) return;
      try {
        const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=bfba7f78869e4222b89154845251302&q=${city}&aqi=no`);
        if (!response.ok) throw new Error("API error");
        const data = await response.json();
        const weatherInfo = `<p>×˜××¤×¨×˜×•×¨×”: ${data.current.temp_c}Â°C</p><p>×ª× ××™×: ${data.current.condition.text}</p>`;
        document.getElementById('weather-info').innerHTML = weatherInfo;
        showClothingRecommendations(data.current);
        generateBagItems();
      } catch (error) {
        showMessage('×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™ ××–×’ ××•×•×™×¨', 'error');
        console.error("Error fetching weather:", error);
      }
    }
    // NEW: Improved Clothing Recommendations Function
    function showClothingRecommendations(weather) {
      const recommendations = [];
      const temp = weather.temp_c;
      const condition = weather.condition.text.toLowerCase();
      // Temperature-based recommendations
      if (temp <= 0) {
        recommendations.push('××¢×™×œ ×—×–×§, ×›×¤×¤×•×ª, ×›×•×‘×¢ ×—×');
      } else if (temp <= 10) {
        recommendations.push('××¢×™×œ, ×¦×¢×™×£');
      } else if (temp <= 20) {
        recommendations.push('×¡×•×•×“×¨ ××• ×—×œ×™×¤×” ×§×œ×”');
      } else {
        recommendations.push('×œ×‘×•×© ×§×œ ×•× ×•×—');
      }
      // Precipitation-based recommendations
      if (weather.precip_mm > 0) {
        recommendations.push('××˜×¨×™×” ××• ××¢×™×œ ×’×©×');
      }
      // Sunny condition (only if warm enough)
      if (condition.includes('×©××©') && temp >= 20) {
        recommendations.push('×›×•×‘×¢ ×•××©×§×¤×™ ×©××©');
      }
      // Wind-based recommendation if wind is strong
      if (weather.wind_kph && weather.wind_kph > 20) {
        recommendations.push('×”×¦×˜×™×™×“×• ×‘××¢×™×œ ×¨×•×—');
      }
      const html = `<strong>×”××œ×¦×•×ª ×œ×‘×•×©:</strong><ul>${recommendations.map(item => `<li>${item}</li>`).join('')}</ul>`;
      document.getElementById('clothing-recommendations').innerHTML = html;
    }
    function generateBagItems() {
      if (!currentUser || !users[currentUser].schedule) return;
      const itemsByDay = users[currentUser].schedule.map((subjects, index) => {
        const day = daysOfWeek[index];
        const items = [];
        if (subjects.length > 0) items.push('××—×‘×¨×ª', '×¢×˜×™×');
        if (subjects.some(s => s.includes('××ª××˜×™×§×”'))) items.push('××—×©×‘×•×Ÿ');
        if (subjects.some(s => s.includes('×¡×¤×•×¨×˜'))) items.push('×‘×’×“ ×¡×¤×•×¨×˜');
        return `<div class="day-bag-items"><strong>${day}:</strong> ${items.join(', ')}</div>`;
      }).join('');
      document.getElementById('daily-bag-items').innerHTML = itemsByDay;
    }
    function updateStorage() {
      localStorage.setItem('schoolUsers', JSON.stringify(users));
    }
    function bindSubjectEvents() {
      const subjectCards = document.querySelectorAll('.subject-card');
      subjectCards.forEach(card => {
        card.setAttribute('draggable', true);
        card.addEventListener('dragstart', handleDragStart, false);
        card.addEventListener('dragover', handleDragOver, false);
        card.addEventListener('drop', handleDrop, false);
      });
    }
    // Render the schedule UI
    function renderScheduleUI() {
      const daysContainer = document.getElementById('days-container');
      daysContainer.innerHTML = '';
      if (!users[currentUser] || !users[currentUser].schedule) return;
      users[currentUser].schedule.forEach((subjects, index) => {
        let subjectHTML = subjects.map((subject, i) => `
          <div class="subject-card" data-index="${i}">
            <span onclick="toggleCompleted(this)">${subject}</span>
            <span class="remove-btn" title="Remove" onclick="removeSubject(${index}, '${subject}')">X</span>
            <button onclick="editSubject(${index}, '${subject}')" title="${translations[currentLang].edit}">${translations[currentLang].edit}</button>
            <button onclick="addNote(${index}, '${subject}')" title="${translations[currentLang].addNote}">${translations[currentLang].addNote}</button>
            <button onclick="setReminder(${index}, '${subject}')" title="${translations[currentLang].reminder}">${translations[currentLang].reminder}</button>
            <button onclick="markDone(this)" title="Mark as Completed">âœ”ï¸</button>
          </div>
        `).join('');
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-container';
        dayDiv.innerHTML = `
          <h3>${daysOfWeek[index]}</h3>
          <input type="text" id="subject-input-${index}" placeholder="${translations[currentLang].addSubject}">
          <button onclick="addSubject(${index})" title="${translations[currentLang].addSubject}">${translations[currentLang].addSubject}</button>
          <button onclick="sortSubjects(${index})" title="${translations[currentLang].sortSubjects}">${translations[currentLang].sortSubjects}</button>
          <button onclick="clearDay(${index})" title="${translations[currentLang].clearDay}">${translations[currentLang].clearDay}</button>
          <div id="subjects-${index}">
            ${subjectHTML}
          </div>
        `;
        daysContainer.appendChild(dayDiv);
      });
      bindSubjectEvents();
      updateProgress();
    }
    function addSubject(dayIndex) {
      const input = document.getElementById(`subject-input-${dayIndex}`);
      const subject = input.value.trim();
      if (!subject) {
        showMessage('×× × ×”×–×Ÿ × ×•×©×', 'error');
        return;
      }
      if (!users[currentUser].schedule) {
        users[currentUser].schedule = Array.from({ length: 6 }, () => []);
      }
      users[currentUser].schedule[dayIndex].push(subject);
      updateStorage();
      renderScheduleUI();
      input.value = '';
      generateBagItems();
    }
    function removeSubject(dayIndex, subject) {
      users[currentUser].schedule[dayIndex] = users[currentUser].schedule[dayIndex].filter(s => s !== subject);
      updateStorage();
      renderScheduleUI();
      generateBagItems();
    }
    function editSubject(dayIndex, subject) {
      document.getElementById('subject-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
      document.getElementById('edit-subject-input').value = subject;
      document.getElementById('edit-time-input').value = '08:00-09:00';
      document.getElementById('edit-category-input').value = '×›×œ×œ×™';
    }
    function saveEditedSubject() {
      document.getElementById('subject-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
      showMessage('×”× ×•×©× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
      // (Optional: update the schedule accordingly)
    }
    function exportSchedule() {
      const dataStr = JSON.stringify(users[currentUser].schedule);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const exportFileDefaultName = 'schedule.json';
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }
    function exportScheduleCSV() {
      if (!users[currentUser] || !users[currentUser].schedule) return;
      let csvContent = "data:text/csv;charset=utf-8,";
      users[currentUser].schedule.forEach((subjects, index) => {
        csvContent += daysOfWeek[index] + "," + subjects.join(";") + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "schedule.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    function importSchedule() {
      const inputElement = document.createElement('input');
      inputElement.type = 'file';
      inputElement.accept = 'application/json';
      inputElement.addEventListener('change', function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            users[currentUser].schedule = JSON.parse(e.target.result);
            updateStorage();
            renderScheduleUI();
            generateBagItems();
            showMessage('××¢×¨×›×ª ×”×©×¢×•×ª ×¢×•×“×›× ×”', 'success');
          } catch (error) {
            showMessage('×§×•×‘×¥ ×œ× ×—×•×§×™', 'error');
          }
        };
        reader.readAsText(file);
      });
      inputElement.click();
    }
    function exportToPDF() {
      showMessage('×™×™×¦×•× ×œ-PDF ×‘×”×§×“×', 'success');
    }
    function printSchedule() {
      window.print();
    }
    function showMessage(message, type) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type}`;
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }
    let dragSrcEl = null;
    function handleDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      return false;
    }
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      if (dragSrcEl !== this) {
        dragSrcEl.innerHTML = this.innerHTML;
        this.innerHTML = e.dataTransfer.getData('text/html');
        updateStorage();
      }
      return false;
    }
    // Debounce function for improved search performance
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }
    document.getElementById('search-input').addEventListener('input', debounce(function() {
      const query = this.value.toLowerCase();
      const dayContainers = document.querySelectorAll('.day-container');
      dayContainers.forEach(container => {
        const subjects = container.querySelectorAll('.subject-card');
        subjects.forEach(card => {
          card.style.display = card.textContent.toLowerCase().includes(query) ? 'flex' : 'none';
        });
      });
    }, 300));
    function sortSubjects(dayIndex) {
      users[currentUser].schedule[dayIndex].sort();
      updateStorage();
      renderScheduleUI();
    }
    function addNote(dayIndex, subject) {
      const note = prompt('×”×–×Ÿ ×”×¢×¨×” ×¢×‘×•×¨ ×”× ×•×©×:');
      if (note) {
        const newSubject = subject + ' (' + note + ')';
        removeSubject(dayIndex, subject);
        users[currentUser].schedule[dayIndex].push(newSubject);
        updateStorage();
        renderScheduleUI();
      }
    }
    function renderCalendar() {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      const date = new Date();
      const currentDay = date.getDate();
      for (let i = 1; i <= 31; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.textContent = i;
        dayDiv.style.background = (i === currentDay) ? 'var(--secondary-color)' : '#fff';
        dayDiv.style.color = (i === currentDay) ? '#fff' : 'var(--primary-color)';
        dayDiv.addEventListener('click', () => alert('× ×‘×—×¨ ×”×™×•×: ' + i));
        calendar.appendChild(dayDiv);
      }
    }
    renderCalendar();
    function setReminder(dayIndex, subject) {
      const reminderTime = prompt('×”×–×Ÿ ×–××Ÿ ×ª×–×›×•×¨×ª (×œ×“×•×’××”: 07:30):');
      if (reminderTime) {
        if (Notification.permission !== "granted") {
          Notification.requestPermission().then(permission => {
            if (permission === "granted") {
              new Notification('×ª×–×›×•×¨×ª', { body: subject + ' - ' + reminderTime });
            }
          });
        } else {
          new Notification('×ª×–×›×•×¨×ª', { body: subject + ' - ' + reminderTime });
        }
        showMessage('×ª×–×›×•×¨×ª ×¢×‘×•×¨ ' + subject + ' ×”×•×’×“×¨×” ×œ×©×¢×” ' + reminderTime, 'success');
      }
    }
    function clearDay(dayIndex) {
      if (confirm('×”×× ×œ××—×•×§ ××ª ×›×œ ×”× ×•×©××™× ×©×œ ×”×™×•×?')) {
        users[currentUser].schedule[dayIndex] = [];
        updateStorage();
        renderScheduleUI();
        generateBagItems();
        showMessage('×”× ×•×©××™× × ××—×§×•', 'success');
      }
    }
    function filterByCategory(category) {
      const dayContainers = document.querySelectorAll('.day-container');
      dayContainers.forEach(container => {
        const subjects = container.querySelectorAll('.subject-card');
        subjects.forEach(card => {
          card.style.display = (card.textContent.includes(category) || category === 'all') ? 'flex' : 'none';
        });
      });
    }
    function backupToCloud() {
      showMessage('×’×™×‘×•×™ ×œ×¢× ×Ÿ ×”×¦×œ×™×—', 'success');
    }
    function restoreFromCloud() {
      showMessage('×©×—×–×•×¨ ××’×™×‘×•×™ ×”×¢× ×Ÿ ×”×¦×œ×™×—', 'success');
    }
    function showAuthForm(formType) {
      document.getElementById('login-or-register').style.display = 'none';
      if (formType === 'register') {
        document.getElementById('register-form').style.display = 'block';
      } else {
        document.getElementById('login-form').style.display = 'block';
      }
    }
    function register() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm-password').value;
      if (!username || !password || !confirmPassword) {
        showMessage('×›×œ ×”×©×“×•×ª × ×“×¨×©×™×', 'error');
        return;
      }
      if (password !== confirmPassword) {
        showMessage('×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª', 'error');
        return;
      }
      if (users[username]) {
        showMessage('×©× ×”××©×ª××© ×›×‘×¨ ×§×™×™×', 'error');
        return;
      }
      users[username] = { password, schedule: Array.from({ length: 6 }, () => []) };
      updateStorage();
      showMessage('×”×¨×©××” ×”×¦×œ×™×—×”!', 'success');
      currentUser = username;
      document.getElementById('current-user').textContent = currentUser;
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      renderScheduleUI();
    }
    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) {
        showMessage('×›×œ ×”×©×“×•×ª × ×“×¨×©×™×', 'error');
        return;
      }
      if (!users[username] || users[username].password !== password) {
        showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
        return;
      }
      showMessage('×”×ª×—×‘×¨×•×ª ×”×¦×œ×™×—×”!', 'success');
      currentUser = username;
      document.getElementById('current-user').textContent = currentUser;
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      renderScheduleUI();
      generateBagItems();
    }
    function logout() {
      currentUser = null;
      showMessage('×”×ª× ×ª×§×ª ××”××¢×¨×›×ª', 'success');
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('auth-container').style.display = 'block';
    }
    function updateClock() {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    function markDone(btn) {
      btn.parentElement.classList.toggle('completed');
      updateProgress();
    }
    function updateProgress() {
      const allCards = document.querySelectorAll('.subject-card');
      const total = allCards.length;
      let completed = 0;
      allCards.forEach(card => { if (card.classList.contains('completed')) completed++; });
      const percent = total ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progress-bar').style.width = percent + "%";
    }
    function startSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        showMessage('×“×™×‘×•×¨ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”', 'error');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = currentLang === 'en' ? 'en-US' : (currentLang === 'ru' ? 'ru-RU' : (currentLang === 'ar' ? 'ar-SA' : (currentLang === 'es' ? 'es-ES' : 'he-IL')));
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        if (currentUser && users[currentUser].schedule) {
          users[currentUser].schedule[0].push(transcript);
          updateStorage();
          renderScheduleUI();
          showMessage('× ×•×©× × ×•×¡×£ ×‘×××¦×¢×•×ª ×§×•×œ: ' + transcript, 'success');
        }
      };
      recognition.onerror = function() {
        showMessage('×©×’×™××” ×‘×”×›×¨×” ×§×•×œ×™×ª', 'error');
      };
      recognition.start();
    }
    /***************** NEW: Bag Management Functions *****************/
    function openBagModal() {
      document.getElementById('bag-modal').style.display = 'block';
      document.getElementById('modal-overlay').style.display = 'block';
    }
    function closeBagModal() {
      document.getElementById('bag-modal').style.display = 'none';
      document.getElementById('modal-overlay').style.display = 'none';
    }
    function checkBagContents() {
      const daySelect = document.getElementById('bag-day-select');
      const currentDayIndex = parseInt(daySelect.value);
      let previousDayIndex = currentDayIndex - 1;
      if (previousDayIndex < 0) previousDayIndex = 5;
      const schedule = users[currentUser].schedule;
      const currentSchedule = new Set(schedule[currentDayIndex] || []);
      const previousSchedule = new Set(schedule[previousDayIndex] || []);
      const subjectsToAdd = Array.from(currentSchedule).filter(x => !previousSchedule.has(x));
      const subjectsToRemove = Array.from(previousSchedule).filter(x => !currentSchedule.has(x));
      let resultHtml = `<p>×œ×¤×™ ××¢×¨×›×ª ×”×©×¢×•×ª:</p>`;
      resultHtml += `<p>×”×™×•× ×”× ×‘×—×¨: ${daysOfWeek[currentDayIndex]}</p>`;
      resultHtml += `<p>×”×™×•× ×”×§×•×“×: ${daysOfWeek[previousDayIndex]}</p>`;
      resultHtml += `<p><strong>×œ×”×•×¡×¤×”:</strong> ${subjectsToAdd.length ? subjectsToAdd.join(', ') : '××™×Ÿ â€“ ×›×œ ×”×—×•××¨×™× ×§×™×™××™×'}</p>`;
      resultHtml += `<p><strong>×œ×”×¡×¨×”:</strong> ${subjectsToRemove.length ? subjectsToRemove.join(', ') : '××™×Ÿ â€“ ××™×Ÿ ×¦×•×¨×š ×œ×”×¡×™×¨'}</p>`;
      document.getElementById('bag-results').innerHTML = resultHtml;
    }
    /***************** Initialization *****************/
    document.addEventListener('DOMContentLoaded', () => {
      currentLang = localStorage.getItem('currentLang') || currentLang;
      const savedTheme = localStorage.getItem('currentTheme') || 'light';
      setTheme(savedTheme);
      const savedCustomTheme = localStorage.getItem('currentCustomTheme') || 'light';
      setCustomTheme(savedCustomTheme);
      const savedFont = localStorage.getItem('currentFont') || 'Arial';
      changeFont(savedFont);
      updateLanguage();
      renderScheduleUI();
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser && users[savedUser]) {
        currentUser = savedUser;
        document.getElementById('current-user').textContent = currentUser;
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        renderScheduleUI();
        generateBagItems();
      }
    });
    window.addEventListener('beforeunload', () => {
      if (currentUser) localStorage.setItem('currentUser', currentUser);
    });
  </script>
</body>
</html>
